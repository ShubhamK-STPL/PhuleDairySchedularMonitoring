name: Selenium Hangfire Status Job

on:
  push:
    paths:
      - '.github/workflows/selenium-hangfire-status.yml'
  schedule:
    - cron: "30 3 * * *"   # Runs every day at 9:00 IST (3:30 UTC)
  workflow_dispatch:        # Manual trigger

jobs:
  run-tests:
    runs-on: ubuntu-latest

    steps:
      # Checkout code
      - name: Checkout Repository
        uses: actions/checkout@v3

      # Set up Java 17
      - name: Set up JDK 17
        uses: actions/setup-java@v3
        with:
          java-version: '17'
          distribution: 'temurin'

      # Cache Maven Dependencies
      - name: Cache Maven Dependencies
        uses: actions/cache@v3
        with:
          path: ~/.m2
          key: ${{ runner.os }}-maven-${{ hashFiles('**/pom.xml') }}
          restore-keys: ${{ runner.os }}-maven

      # Install Google Chrome for Selenium tests
      - name: Install Google Chrome
        uses: browser-actions/setup-chrome@v1

      # Run Selenium Tests
      - name: Run Tests with Maven
        id: tests
        run: |
          set +e
          mvn clean test -DsuiteXmlFile=testng.xml
          RESULT=$?
          if [ $RESULT -eq 0 ]; then
            echo "test_status=âœ… Tests Passed" >> $GITHUB_OUTPUT
          else
            echo "test_status=âŒ Tests Failed" >> $GITHUB_OUTPUT
          fi
          exit $RESULT

      # Get Hangfire Job Status (Example: Using cURL to call your API)
      - name: Get Hangfire Job Status
        id: hangfire
        run: |
          STATUS=$(curl -s $HANGFIRE_URL | jq -r '.status // "Unknown"')
          echo "hangfire_status=$STATUS" >> $GITHUB_OUTPUT

      # Send Notification to Microsoft Teams
      - name: Send Notification to Teams
        run: |
          JOB_STATUS="${{ steps.hangfire.outputs.hangfire_status }}"
          TEST_STATUS="${{ steps.tests.outputs.test_status }}"
          MESSAGE="{
            \"@type\": \"MessageCard\",
            \"@context\": \"https://schema.org/extensions\",
            \"themeColor\": \"0076D7\",
            \"summary\": \"Hangfire Job Status Report\",
            \"sections\": [{
              \"activityTitle\": \"ðŸš€ Selenium Hangfire Status\",
              \"facts\": [
                {\"name\": \"Hangfire Job Status\", \"value\": \"$JOB_STATUS\"},
                {\"name\": \"Test Execution\", \"value\": \"$TEST_STATUS\"}
              ],
              \"markdown\": true
            }]
          }"

          curl -H "Content-Type: application/json" \
               -d "$MESSAGE" \
               $TEAMS_WEBHOOK_URL

    env:
      TEAMS_WEBHOOK_URL: ${{ secrets.TEAMS_WEBHOOK_URL }}
      HANGFIRE_URL: ${{ secrets.HANGFIRE_URL }}
