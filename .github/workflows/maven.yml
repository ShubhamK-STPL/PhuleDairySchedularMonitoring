name: Selenium Hangfire Status Job

on:
  push:                     # ✅ Trigger when any file changes
    branches:
      - main
  schedule:
    - cron: "30 3 * * *"    # ✅ Runs every day at 9:00 IST (3:30 UTC)
  workflow_dispatch:        # ✅ Manual trigger option

jobs:
  run-tests:
    runs-on: ubuntu-latest
    outputs:
      test_status: ${{ steps.tests.outputs.test_status }}
    steps:
      # ✅ Checkout code
      - name: Checkout Repository
        uses: actions/checkout@v3

      # ✅ Set up Java 17
      - name: Set up JDK 17
        uses: actions/setup-java@v3
        with:
          java-version: '17'
          distribution: 'temurin'

      # ✅ Cache Maven Dependencies
      - name: Cache Maven Dependencies
        uses: actions/cache@v3
        with:
          path: ~/.m2
          key: ${{ runner.os }}-maven-${{ hashFiles('**/pom.xml') }}
          restore-keys: ${{ runner.os }}-maven

      # ✅ Install Google Chrome for Selenium tests
      - name: Install Google Chrome
        uses: browser-actions/setup-chrome@v1

      # ✅ Run Selenium Tests (PhuleDairyJobStatus will send Teams notification)
      - name: Run Tests with Maven
        id: tests
        run: |
          set +e
          mvn clean test -DsuiteXmlFile=testng.xml
          RESULT=$?
          if [ $RESULT -eq 0 ]; then
            echo "test_status=✅ Tests Passed" >> $GITHUB_OUTPUT
          else
            echo "test_status=❌ Tests Failed" >> $GITHUB_OUTPUT
          fi
          exit $RESULT

    env:
      TEAMS_WEBHOOK_URL: ${{ secrets.TEAMS_WEBHOOK_URL }}
      HANGFIRE_URL: ${{ secrets.HANGFIRE_URL }}

  # ✅ Separate Job to Check Hangfire Status and Send Teams Notification
  check-hangfire-and-notify:
    runs-on: ubuntu-latest
    needs: run-tests
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3

      - name: Set up JDK 17
        uses: actions/setup-java@v3
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Cache Maven Dependencies
        uses: actions/cache@v3
        with:
          path: ~/.m2
          key: ${{ runner.os }}-maven-${{ hashFiles('**/pom.xml') }}
          restore-keys: ${{ runner.os }}-maven

      - name: Install Google Chrome
        uses: browser-actions/setup-chrome@v1

      # ✅ Execute only Teams Notification Part (re-run test class if needed)
      - name: Send Hangfire Job Status to Teams
        run: mvn -Dtest=PhuleDairyJobStatus test

    env:
      TEAMS_WEBHOOK_URL: ${{ secrets.TEAMS_WEBHOOK_URL }}
      HANGFIRE_URL: ${{ secrets.HANGFIRE_URL }}
